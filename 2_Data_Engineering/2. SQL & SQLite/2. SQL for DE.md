# Real-World SQL in a Data Pipeline (Sakila Example)

## Overview
This example demonstrates how SQL fits into the daily workflow of a data engineer using the **Sakila database**.  

At SakilaFlix, a junior data engineer is tasked with building a daily report showing:
- Total rentals made yesterday  
- Most popular films  
- Total revenue generated  

### Example Query: Rentals & Revenue Yesterday
```sql
SELECT
  DATE(rental_date) AS rental_day,
  COUNT(rental_id) AS total_rentals,
  SUM(payment.amount) AS total_revenue
FROM rental
JOIN payment ON rental.rental_id = payment.rental_id
WHERE DATE(rental_date) = DATE('now', '-1 day')
GROUP BY rental_day;
```
This query can later be automated and integrated into a pipeline.

---

## What Is Orchestration?
- **Definition**: Orchestration manages the timing, order and monitoring of tasks in a data pipeline.
- **Analogy**: Like a conductor guiding a symphony.
Pipeline Example:
1. Fetch raw data from API
2. Clean/transform with SQL
3. Save to dashboard
Key Needs:
- Correct order
- Scheduled timing (daily, weekly, etc.)
- Error checks
Popular Tools:
- **Airflow** → Schedule/run SQL or Python
- **dbt** → SQL-based transformations
- **Dagster** → SQL + Python + monitoring
---

## SQL Challenges (Sakila Database)
1. Rentals per Day (Past 7 Days)
```sql
SELECT
  DATE(rental_date) AS rental_day,
  COUNT(*) AS total_rentals
FROM rental
WHERE rental_date >= DATE('now', '-7 day')
GROUP BY rental_day
ORDER BY rental_day;
```
2. Top 5 Most Rented Films (Last 30 Days)
```sql
SELECT
  f.title,
  COUNT(r.rental_id) AS rental_count
FROM rental r
JOIN inventory i ON r.inventory_id = i.inventory_id
JOIN film f ON i.film_id = f.film_id
WHERE r.rental_date >= DATE('now', '-30 day')
GROUP BY f.title
ORDER BY rental_count DESC
LIMIT 5;
```
3. Total Revenue per Store
```sql
SELECT
  s.store_id,
  SUM(p.amount) AS total_revenue
FROM payment p
JOIN staff st ON p.staff_id = st.staff_id
JOIN store s ON st.store_id = s.store_id
GROUP BY s.store_id;
```
4. Customers with >3 Rentals Last Month
```sql
SELECT
  c.customer_id,
  c.first_name,
  c.last_name,
  COUNT(r.rental_id) AS total_rentals
FROM rental r
JOIN customer c ON r.customer_id = c.customer_id
WHERE strftime('%Y-%m', r.rental_date) = strftime('%Y-%m', DATE('now', '-1 month'))
GROUP BY c.customer_id
HAVING COUNT(r.rental_id) > 3;
```
5. Custom Report – Top Film Category by Revenue
```sql
SELECT
  c.name AS category,
  SUM(p.amount) AS total_revenue
FROM payment p
JOIN rental r ON p.rental_id = r.rental_id
JOIN inventory i ON r.inventory_id = i.inventory_id
JOIN film f ON i.film_id = f.film_id
JOIN film_category fc ON f.film_id = fc.film_id
JOIN category c ON fc.category_id = c.category_id
GROUP BY c.name
ORDER BY total_revenue DESC
LIMIT 1;
```
---

## Key Takeaways
- SQL provides the **logic layer** of a data pipeline.
- Orchestration ensures SQL runs **on time, in order, with monitoring**.
- Tools like **Airflow, dbt and Dagster** help automate these pipelines.
- Practicing SQL queries now lays the foundation for building robust data workflows later.
